@page "/notebookdetail/{NotebookId}"
@using ApexLM.Services
@using ApexLM.Components
@using MudBlazor
@inject NavigationManager Navigation
@inject ILayoutService LayoutService

<MudLayout>
    <!-- Mobile Header -->
    <MudAppBar Elevation="1" Class="d-lg-none">
        <MudIconButton Icon="Icons.Material.Filled.ArrowBack"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="GoBack" />
        <MudSpacer />
        <MudText Typo="Typo.h6" Class="text-truncate px-2">
            @currentNotebook?.Title
        </MudText>
        <MudSpacer />
        <MudIconButton Icon="Icons.Material.Filled.MoreVert"
                       Color="Color.Inherit"
                       Edge="Edge.End" />
    </MudAppBar>

    <MudMainContent>
        <div class="notebook-container">
            <!-- Mobile Tab Navigation -->
            <MudPaper Class="d-lg-none mobile-tabs" Elevation="0">
                <MudTabs @bind-ActivePanelIndex="mobileActiveTab" Color="Color.Primary" Centered="true">
                    <MudTabPanel Text="Sources">
                        <MudIcon Icon="@Icons.Material.Filled.Folder" Class="mr-2" />
                        Sources
                    </MudTabPanel>
                    <MudTabPanel Text="Chat">
                        <MudIcon Icon="@Icons.Material.Filled.Chat" Class="mr-2" />
                        Chat
                    </MudTabPanel>
                    <MudTabPanel Text="Studio">
                        <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Class="mr-2" />
                        Studio
                    </MudTabPanel>
                </MudTabs>
            </MudPaper>

            <!-- Three Pane Layout -->
            <div class="three-pane-container">
                <!-- Left Pane - Sources -->
                <div class="pane left-pane d-none d-lg-block">
                    <SourcePanel NotebookId="@NotebookId"
                                 SourceCount="@(currentNotebook?.SourceCount ?? 0)" />
                </div>

                <!-- Middle Pane - Chat -->
                <div class="pane middle-pane @(mobileActiveTab == 1 ? "d-block" : "d-lg-block")">
                    <ChatArea NotebookId="@NotebookId"
                              NotebookTitle="@currentNotebook?.Title" />
                </div>

                <!-- Right Pane - Studio -->
                <div class="pane right-pane d-none d-lg-block">
                    <StudioPanel NotebookId="@NotebookId" />
                </div>

                <!-- Mobile Panes -->
                <div class="d-lg-none">
                    @if (mobileActiveTab == 0)
                    {
                        <div class="mobile-pane">
                            <SourcePanel NotebookId="@NotebookId"
                                         SourceCount="@(currentNotebook?.SourceCount ?? 0)"
                                         IsMobile="true" />
                        </div>
                    }
                    else if (mobileActiveTab == 2)
                    {
                        <div class="mobile-pane">
                            <StudioPanel NotebookId="@NotebookId"
                                         IsMobile="true" />
                        </div>
                    }
                </div>
            </div>
        </div>
    </MudMainContent>
</MudLayout>

<style>
    .notebook-container {
        height: 85vh;
        display: flex;
        flex-direction: column;
        background-color: var(--mud-palette-background);
    }

    .three-pane-container {
        display: flex;
        flex: 1;
        height: calc(100vh - 64px);
        overflow: hidden;
        min-height: 0; /* Important for flexbox scrolling */
    }

    .pane {
        height: 100%;
        overflow-y: auto;
        border-right: 1px solid var(--mud-palette-lines-default);
        background-color: var(--mud-palette-background);
        display: flex;
        flex-direction: column;
        min-height: 0; /* Important for flexbox scrolling */
    }

    .left-pane {
        width: 380px;
        min-width: 380px;
        flex-shrink: 0;
    }

    .middle-pane {
        flex: 1;
        min-width: 0;
    }

    .right-pane {
        width: 320px;
        min-width: 320px;
        flex-shrink: 0;
        border-right: none;
    }

    .mobile-tabs {
        flex-shrink: 0;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .mobile-pane {
        height: calc(100vh - 112px);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        min-height: 0; /* Important for flexbox scrolling */
    }

    /* Scrollbar styling */
    .pane::-webkit-scrollbar {
        width: 6px;
    }

    .pane::-webkit-scrollbar-track {
        background: transparent;
    }

    .pane::-webkit-scrollbar-thumb {
        background: var(--mud-palette-action-disabled);
        border-radius: 3px;
    }

        .pane::-webkit-scrollbar-thumb:hover {
            background: var(--mud-palette-action-disabled-background);
        }
</style>